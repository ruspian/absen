
generator client {
  provider = "prisma-client"
  output   = "./src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// MODEL USER (SUDAH DIPERBAIKI)
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String    
  role          Role      @default(GURU) 

  accounts    Account[]
  sessions    Session[]

  // Relasi ke Guru
  guruProfil  Guru?    @relation("UserGuru")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// MODEL AKUN (Bawaan NextAuth)
model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
}

// MODEL SESSION (Bawaan NextAuth)
model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// MODEL VERIFICATION TOKEN (Bawaan NextAuth)
model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
}

enum Role {
  ADMIN
  GURU
}

enum Gender {
  LAKI_LAKI
  PEREMPUAN
}

// MODEL GURU
model Guru {
  id      String   @id @default(cuid())
  nama    String
  kode    String   @unique
  nip     String?  @unique
  nuptk   String?  @unique
  gender  Gender   @default(LAKI_LAKI)
  isPiket Boolean  @default(false) // Penanda Guru Piket
  
  
  // Relasi balik ke akun login-nya
  user    User?    @relation("UserGuru", fields: [userId], references: [id])
  userId  String?  @unique // Satu akun login untuk satu profil guru

  // Relasi lain
  mengajarDiJadwal JadwalPelajaran[] @relation("GuruPengajar")
  waliDiKelas      Kelas?            @relation("WaliKelas")
}


// MODEL SISWA
model Siswa {
  id      String   @id @default(cuid())
  nama    String
  nisn     String   @unique
  kode    String   @unique
  gender  Gender   @default(LAKI_LAKI)

  
  // Relasi ke Kelas
  kelas   Kelas    @relation(fields: [kelasId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  kelasId String

  // Relasi ke data absennya
  absenHarian AbsenHarian[]
  absenMapel  AbsenMapel[]
}

// MODEL KELAS
model Kelas {
  id          String   @id @default(cuid())
  nama        String   @unique 
  
  // Relasi ke Wali Kelas 
  waliKelas   Guru?    @relation("WaliKelas", fields: [waliKelasId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  waliKelasId String?  @unique

  // Relasi ke Siswa
  siswa       Siswa[]
  
  // Relasi ke Jadwal
  jadwal      JadwalPelajaran[]
}

// MODEL MATA PELAJARAN
model MataPelajaran {
  id     String   @id @default(cuid())
  kode   String   @unique 
  nama   String   
  
  // Relasi ke Jadwal
  jadwal JadwalPelajaran[]
}

// MODEL JADWAL MATA PELAJARAN
model JadwalPelajaran {
  id          String   @id @default(cuid())
  hari        String   
  jamMulai    DateTime 
  jamSelesai  DateTime 
  
  // Relasi ke Kelas
  kelas       Kelas         @relation(fields: [kelasId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  kelasId     String
  
  // Relasi ke Mata Pelajaran
  mapel       MataPelajaran @relation(fields: [mapelId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  mapelId     String
  
  // Relasi ke Guru Pengajar
  guru        Guru          @relation("GuruPengajar", fields: [guruId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  guruId      String
  
  // Relasi ke AbsenMapel
  absenMapel AbsenMapel[]
}


// MODEL ABSEN HARIAN
model AbsenHarian {
  id         String       @id @default(cuid())
  tanggal    DateTime     @db.Date 
  jamMasuk   DateTime?    @db.Time 
  jamPulang  DateTime?    @db.Time 
  status     StatusHarian @default(ALFA)
  
  // Relasi ke Siswa
  siswa      Siswa        @relation(fields: [siswaId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  siswaId    String
  
  //  1 siswa hanya punya 1 rekor absen harian per tanggal
  @@unique([siswaId, tanggal])
}

enum StatusHarian {
  HADIR
  SAKIT
  IZIN
  ALFA
}

// MODEL ABSEN MAPEL
model AbsenMapel {
  id          String      @id @default(cuid())
  tanggal     DateTime    @db.Date 
  status      StatusMapel @default(ALFA)
  keterangan  String?
  hari        String   
  jamMulai    DateTime @db.Time 
  jamSelesai  DateTime @db.Time 
  
  // Relasi ke Siswa
  siswa       Siswa       @relation(fields: [siswaId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  siswaId     String
  
  // Relasi ke Jadwal Pelajaran
  jadwal      JadwalPelajaran @relation(fields: [jadwalId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  jadwalId    String
  
  //  1 siswa diabsen 1x per jadwal per tanggal
  @@unique([siswaId, jadwalId, tanggal])
}

enum StatusMapel {
  HADIR
  SAKIT
  IZIN
  ALFA
}
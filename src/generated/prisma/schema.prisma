generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String
  role          Role      @default(GURU)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLogin     DateTime?
  accounts      Account[]
  guruProfil    Guru?     @relation("UserGuru")
  sessions      Session[]
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
}

model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
}

model Guru {
  id               String            @id @default(cuid())
  nama             String
  kode             String            @unique
  nip              String?           @unique
  nuptk            String?           @unique
  gender           Gender            @default(LAKI_LAKI)
  // isPiket          Boolean           @default(false)
  userId           String?           @unique
  user             User?             @relation("UserGuru", fields: [userId], references: [id])
  mengajarDiJadwal JadwalPelajaran[] @relation("GuruPengajar")
  waliDiKelas      Kelas?            @relation("WaliKelas")

  jadwalPiket JadwalPiket[]
  absenHarian AbsenGuruHarian[]
}

model JadwalPiket {
  id     String @id @default(cuid())
  hari   String
  guruId String
  guru   Guru   @relation(fields: [guruId], references: [id], onDelete: Cascade)

  @@unique([hari, guruId])
}

model Siswa {
  id          String        @id @default(cuid())
  nama        String
  nisn        String        @unique
  kode        String        @unique
  gender      Gender        @default(LAKI_LAKI)
  kelasId     String
  absenHarian AbsenHarian[]
  absenMapel  AbsenMapel[]
  kelas       Kelas         @relation(fields: [kelasId], references: [id])
}

model Kelas {
  id          String            @id @default(cuid())
  nama        String            @unique
  waliKelasId String?           @unique
  jadwal      JadwalPelajaran[]
  waliKelas   Guru?             @relation("WaliKelas", fields: [waliKelasId], references: [id])
  siswa       Siswa[]
}

model MataPelajaran {
  id     String            @id @default(cuid())
  kode   String            @unique
  nama   String
  jadwal JadwalPelajaran[]
}

model JadwalPelajaran {
  id         String        @id @default(cuid())
  hari       String
  jamMulai   DateTime
  jamSelesai DateTime
  kelasId    String
  mapelId    String
  guruId     String
  absenMapel AbsenMapel[]
  guru       Guru          @relation("GuruPengajar", fields: [guruId], references: [id])
  kelas      Kelas         @relation(fields: [kelasId], references: [id], onDelete: Cascade)
  mapel      MataPelajaran @relation(fields: [mapelId], references: [id])
}

model AbsenHarian {
  id        String       @id @default(cuid())
  tanggal   DateTime     @db.Date
  jamMasuk  DateTime?    @db.Time(6)
  jamPulang DateTime?    @db.Time(6)
  status    StatusHarian @default(ALFA)
  siswaId   String
  siswa     Siswa        @relation(fields: [siswaId], references: [id], onDelete: Cascade)

  @@unique([siswaId, tanggal])
}

model AbsenMapel {
  id         String          @id @default(cuid())
  tanggal    DateTime        @db.Date
  status     StatusMapel     @default(ALFA)
  keterangan String?
  hari       String
  jamMulai   DateTime        @db.Time(6)
  jamSelesai DateTime        @db.Time(6)
  siswaId    String
  jadwalId   String
  jadwal     JadwalPelajaran @relation(fields: [jadwalId], references: [id], onDelete: Cascade)
  siswa      Siswa           @relation(fields: [siswaId], references: [id], onDelete: Cascade)

  @@unique([siswaId, jadwalId, tanggal])
}

enum Role {
  ADMIN
  GURU
}

enum Gender {
  LAKI_LAKI
  PEREMPUAN
}

enum StatusHarian {
  HADIR
  SAKIT
  IZIN
  ALFA
}

enum StatusMapel {
  HADIR
  SAKIT
  IZIN
  ALFA
}

model AbsenGuruHarian {
  id        String       @id @default(cuid())
  tanggal   DateTime     @db.Date
  jamMasuk  DateTime?    @db.Time(6)
  jamPulang DateTime?    @db.Time(6)
  status    StatusHarian @default(ALFA)

  // Relasi ke Guru
  guru   Guru   @relation(fields: [guruId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  guruId String

  @@unique([guruId, tanggal])
}
